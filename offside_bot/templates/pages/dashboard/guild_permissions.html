{% from "macros/ui.html" import badge, button %}

<div class="card hero-card">
  <a class="back-link" href="/guild/{{ guild_id }}">&larr; Back</a>
  <div class="kicker mt-12">Setup</div>
  <h1 class="mt-10 text-hero-sm">Permissions Check{% if is_admin %} {{ badge("ADMIN", "pro") }}{% endif %}</h1>
  <p class="muted mt-8">Verify the bot can manage roles and (optionally) clean up legacy Offside channels.</p>
</div>
{% if blocked_message %}
  <div class="card">
    <p class="muted">{{ blocked_message }}</p>
    <div class="mt-10">
      {{ button("Invite bot to this server", invite_href, "blue") }}
    </div>
  </div>
{% else %}
  <div class="row">
    <div class="card">
      <div><strong>Guild</strong></div>
      <div class="muted">ID: <code>{{ guild_id }}</code></div>
      <div class="muted">Bot top role: <code>{{ top_role_name or "unknown" }}</code> (pos {{ top_role_pos }})</div>
      <div class="mt-10">
        {{ button("Open settings", settings_href, "secondary") }}
      </div>
    </div>
    <div class="card">
      <div><strong>Fix steps</strong></div>
      <div class="muted mt-8">
        1) Server Settings &rarr; Roles: ensure the bot role has Manage Roles (and Manage Channels if you want cleanup).<br/>
        2) Drag the bot role above Coach roles (role hierarchy).<br/>
        3) Re-run setup after updating permissions and role order.
      </div>
      <div class="mt-10">
        {{ button("Re-invite with permissions", invite_href, "blue") }}
      </div>
    </div>
  </div>
  <div class="card">
    <h2 class="mt-0">Guild-level permissions</h2>
    <table>
      <thead><tr><th>permission</th><th>status</th><th>why</th></tr></thead>
      <tbody>
        {% if guild_permissions %}
          {% for row in guild_permissions %}
            <tr>
              <td>{{ row.permission }}</td>
              <td><code>{{ row.status }}</code></td>
              <td class="muted">{{ row.why }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="3" class="muted">No permissions to check.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  <div class="card">
    <h2 class="mt-0">Role hierarchy</h2>
    <table>
      <thead><tr><th>role</th><th>status</th><th>details</th></tr></thead>
      <tbody>
        {% if role_hierarchy %}
          {% for row in role_hierarchy %}
            <tr>
              <td>{{ row.role }}</td>
              <td><code>{{ row.status }}</code></td>
              <td class="muted">{{ row.details }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="3" class="muted">No role hierarchy data yet.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  <div class="card">
    <h2 class="mt-0">Channel cleanup</h2>
    <p class="muted">Offside no longer manages Discord portal/report channels. Use Setup Wizard &rarr; Run setup to remove legacy categories.</p>
  </div>
{% endif %}
